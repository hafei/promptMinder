# =====================================================
# PromptMinder Docker Compose 配置 - 生产环境
# 包含前端容器 + 所有后端服务
# =====================================================
services:
  # =====================================================
  # 数据库服务
  # =====================================================
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-promptminder}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-promptminder}
      POSTGRES_DB: ${POSTGRES_DB:-promptminder}
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./docker/init-db:/docker-entrypoint-initdb.d:ro
    # 生产环境不暴露数据库端口
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-promptminder} -d ${POSTGRES_DB:-promptminder}"]
      interval: 5s
      timeout: 5s
      retries: 10

  # =====================================================
  # Kong API 网关 (Supabase 入口)
  # =====================================================
  kong:
    image: kong:3.0
    restart: unless-stopped
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_DNS_ORDER: LAST,A,CNAME
    volumes:
      - ./docker/kong/kong.yml:/kong/kong.yml:ro
    # 生产环境通过前端反向代理，不直接暴露
    depends_on:
      db:
        condition: service_healthy

  # =====================================================
  # PostgREST (REST API)
  # =====================================================
  postgrest:
    image: postgrest/postgrest:v14.1
    restart: unless-stopped
    environment:
      PGRST_DB_URI: postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-key-with-at-least-32-characters-1234}
    depends_on:
      db:
        condition: service_healthy

  # =====================================================
  # Supabase Auth (认证服务)
  # =====================================================
  auth:
    image: supabase/gotrue:v2.158.0
    restart: unless-stopped
    environment:
      # 数据库连接
      DATABASE_URL: postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}
      
      # 站点配置 - 指向前端容器
      GOTRUE_SITE_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}
      SITE_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}
      API_EXTERNAL_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}
      
      # JWT 配置
      GOTRUE_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-key-with-at-least-32-characters-1234}
      JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-key-with-at-least-32-characters-1234}
      JWT_EXP: 3600
      
      # 安全配置
      REFRESH_TOKEN_ROTATION_ENABLED: "true"
      SECURITY_REFRESH_TOKEN_REUSE_INTERVAL: 10
      
      # 邮件配置
      GOTRUE_SMTP_HOST: ${SMTP_HOST:-}
      GOTRUE_SMTP_PORT: ${SMTP_PORT:-587}
      GOTRUE_SMTP_USER: ${SMTP_USER:-}
      GOTRUE_SMTP_PASS: ${SMTP_PASSWORD:-}
      GOTRUE_SMTP_ADMIN_EMAIL: ${FROM_EMAIL:-}
      GOTRUE_MAILER_URLPATHS_CONFIRMATION: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}/auth/callback
      GOTRUE_MAILER_URLPATHS_INVITE: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}/invite
      GOTRUE_MAILER_URLPATHS_RECOVERY: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}/auth/reset-password
      GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}/auth/email-change
      
      # 启用邮箱确认
      GOTRUE_MAILER_AUTOCONFIRM: "false"
      GOTRUE_DISABLE_SIGNUP: "false"
      
      # API 端点
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      
      # 数据库配置
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}
      GOTRUE_DB_MIGRATIONS_PATH: ""
      GOTRUE_DB_AUTOMIGRATE: "false"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9999/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =====================================================
  # MinIO (S3 兼容存储)
  # =====================================================
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 10s

  # =====================================================
  # Storage API (文件存储服务)
  # =====================================================
  storage-api:
    image: supabase/storage-api:v1.32.0
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}
      ANON_KEY: ${SUPABASE_ANON_KEY}
      SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      PGRST_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-key-with-at-least-32-characters-1234}
      FILE_STORAGE_BACKEND: s3
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      S3_ENDPOINT: http://minio:9000
      S3_REGION: us-east-1
      S3_BUCKET: supabase
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
    depends_on:
      db:
        condition: service_healthy
      postgrest:
        condition: service_started

  # =====================================================
  # Supabase Studio (管理界面)
  # =====================================================
  studio:
    image: supabase/studio:v0.24.8
    restart: unless-stopped
    environment:
      # 数据库连接
      SUPABASE_URL: http://kong:8000
      SUPABASE_PUBLIC_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}
      SUPABASE_REST_URL: http://kong:8000/rest/v1/
      SUPABASE_FUNCTIONS_URL: http://kong:8000/functions/v1/
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      
      # 直接数据库连接
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-promptminder}
      DEFAULT_ORGANIZATION_NAME: PromptMinder
      DEFAULT_PROJECT_NAME: promptminder
      
      # Studio 特定配置
      STUDIO_PORT: 3333
      SUPABASE_DB_HOST: db
      SUPABASE_DB_PORT: 5432
      SUPABASE_DB_USER: ${POSTGRES_USER:-promptminder}
      SUPABASE_DB_PASSWORD: ${POSTGRES_PASSWORD:-promptminder}
      SUPABASE_DB_NAME: ${POSTGRES_DB:-promptminder}
    # 生产环境可以选择是否暴露 Studio，通常只在内网访问
    # ports:
    #   - '3333:3333'
    depends_on:
      db:
        condition: service_healthy
      kong:
        condition: service_started
      postgrest:
        condition: service_started
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3333/api/profile"]
      interval: 30s
      timeout: 10s
      retries: 5

  # =====================================================
  # Realtime (实时订阅服务)
  # =====================================================
  realtime:
    image: supabase/realtime:v2.29.5
    restart: unless-stopped
    command: >
      sh -c "
      /bin/sh -c '/app/bin/migrate'
      && /app/bin/realtime eval 'Realtime.Release.set_up!()'
      && /app/bin/server'
      "
    environment:
      # 数据库连接
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-promptminder}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-promptminder}
      DB_NAME: ${POSTGRES_DB:-promptminder}
      DB_AFTER_CONNECT_QUERY: 'SET search_path TO _realtime'
      DB_ENC_KEY: supabaserealtime
      FLY_ALLOC_ID: fly123
      FLY_APP_NAME: realtime
      FLY_REGION: iad
      SECRET_KEY_BASE: UpNVntn3cDxHJpq19/YCq92dC8lDwqU237EKJ8CrY78hEVNSe8Z9eqZOZInHNtB
      API_EXTERNAL_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:40000}
      ERL_AFLAGS: -proto_dist inet_tcp
      DNS_NODES: "''"
      LOG_LEVEL: info
      RLIMIT_NOFILE: 65536
      MAX_CHILDREN: 1000
      ERL_MAX_PORTS: 65536
      ERL_MAX_ETS_TABLES: 65536
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # PromptMinder 前端应用 (生产环境)
  # =====================================================
  web:
    image: promptminder:latest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      kong:
        condition: service_started
      postgrest:
        condition: service_started
      auth:
        condition: service_healthy
    environment:
      NODE_ENV: production
      # Supabase 连接配置 - 指向容器内网络
      SUPABASE_URL: http://kong:8000
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      # 认证配置
      AUTH_SECRET: ${AUTH_SECRET:-your-auth-secret-key-min-32-chars-here}
      # 管理员用户名
      ADMIN_USERNAMES: ${ADMIN_USERNAMES:-admin}
      # 应用配置
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
      # AI 服务配置
      CUSTOM_API_KEY: ${CUSTOM_API_KEY:-}
      CUSTOM_API_URL: ${CUSTOM_API_URL:-}
      CUSTOM_MODEL_NAME: ${CUSTOM_MODEL_NAME:-}
      # 邮件配置
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      FROM_EMAIL: ${FROM_EMAIL:-}
    ports:
      - '40000:3000'  # 暴露前端端口给外部访问

# =====================================================
# 数据卷
# =====================================================
volumes:
  db-data:
    name: promptminder-db-data
  minio-data:
    name: promptminder-minio-data