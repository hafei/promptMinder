version: '3.8'

services:
  # Existing Postgres DB (used by app and Supabase services)
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-promptminder}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-promptminder}
      POSTGRES_DB: ${POSTGRES_DB:-promptminder}
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./sql:/docker-entrypoint-initdb.d:ro
    ports:
      - '${DB_PORT:-5432}:5432'

  # Kong API gateway for Supabase
  kong:
    image: kong:3.0
    restart: unless-stopped
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
    volumes:
      - ./docker/kong/kong.yml:/kong/kong.yml:ro
    ports:
      - '8000:8000'   # proxy
      - '8001:8001'   # admin

  # pg_meta (Supabase metadata service)
  pgmeta:
    image: supabase/pg-meta:latest
    restart: unless-stopped
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}}
      PG_META_DB_SCHEMA: public
      PG_META_PORT: 3001
    ports:
      - '3001:3001'
    depends_on:
      - db

  # PostgREST (Supabase REST endpoint)
  postgrest:
    image: postgrest/postgrest:latest
    restart: unless-stopped
    environment:
      PGRST_DB_URI: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}}
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET:-changeme}
    ports:
      - '3002:3000'
    depends_on:
      - db

  # GoTrue (Auth)
  gotrue:
    image: supabase/gotrue:latest
    restart: unless-stopped
    environment:
      GOTRUE_JWT_SECRET: ${JWT_SECRET:-changeme}
      GOTRUE_SITE_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}}
      GOTRUE_EXTERNAL_EMAIL_ENABLED: 'true'
    ports:
      - '9999:9999'
    depends_on:
      - db

  # Realtime
  realtime:
    image: supabase/realtime:latest
    restart: unless-stopped
    environment:
      DB_HOST: db
      DB_NAME: ${POSTGRES_DB:-promptminder}
      DB_USER: ${POSTGRES_USER:-promptminder}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-promptminder}
      PORT: 4000
    ports:
      - '4000:4000'
    depends_on:
      - db

  # MinIO used as S3-compatible object storage backend for Supabase storage-api
  minio:
    image: minio/minio:latest
    command: server /data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - '9000:9000'
    volumes:
      - minio-data:/data
    restart: unless-stopped

  # Supabase storage-api service
  storage-api:
    image: supabase/storage-api:latest
    restart: unless-stopped
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}}
      ANON_KEY: ${SUPABASE_ANON_KEY:-anonkey}
      SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-service_role_key}
      FILE_STORAGE_BACKEND: s3
      S3_ENDPOINT: http://minio:9000
      S3_REGION: us-east-1
      S3_BUCKET: supabase
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - '54321:54321'
    depends_on:
      - db
      - minio

  # Supabase Studio (optional admin UI)
  studio:
    image: supabase/studio:latest
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL:-http://localhost:8000}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-anonkey}
    ports:
      - '8080:8080'
    depends_on:
      - kong

  # Your application (existing service) â€” keep below so it can refer to SUPABASE envs
  web:
    build: .
    depends_on:
      - db
      - pgmeta
      - kong
      - postgrest
      - gotrue
      - realtime
      - storage-api
    environment:
      NODE_ENV: production
      # Point the app to the local Supabase gateway (Kong proxy). Adjust if you expose different ports.
      SUPABASE_URL: ${SUPABASE_URL:-http://localhost:8000}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-anonkey}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      AUTH_SECRET: ${AUTH_SECRET}
      ZHIPU_API_KEY: ${ZHIPU_API_KEY}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-promptminder}:${POSTGRES_PASSWORD:-promptminder}@db:5432/${POSTGRES_DB:-promptminder}}
    ports:
      - '3000:3000'
    restart: unless-stopped

volumes:
  db-data:
  minio-data:
  storage-data:

# Notes:
# - This compose file provides a convenient local Supabase stack powered by MinIO for storage.
# - You should set SUPABASE_ANON_KEY and SUPABASE_SERVICE_ROLE_KEY in an .env file for realistic keys.
# - After starting, you'll need to initialize Supabase meta/data and create any required roles/keys; consult Supabase docs for migrations and API key generation.
